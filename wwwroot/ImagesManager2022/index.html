<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Images Manager</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.0/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://ajax.googleapis.com/ajax/libs/jqueryui/1.12.1/themes/smoothness/jquery-ui.css">
    <link rel="stylesheet" href="css/site.css">
    <link rel="apple-touch-icon" sizes="180x180" href="images/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="images/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="images/favicon-16x16.png">
    <link rel="icon" href="favicon.ico">
</head>

<body>

    <div class="mainContainer">
        <div class="headerPanel">
            <div class="headerLayout" style="border: 10px;">
                <img src="images/camera.png" alt="" data-toggle="tooltip" class="favicon" title="Gestionnaire d'images">
                <div style="display:flex">
                    <span class="header outLinedText tbg-yellow">
                        P
                    </span>
                    <span class="header outLinedText tbg-orange">
                        I
                    </span>
                    <span class="header outLinedText tbg-red">
                        C
                    </span>
                    <span class="header outLinedText tbg-pink ">
                        T
                    </span>
                    <span class="header outLinedText tbg-black">
                        -
                    </span>
                    <span class="header outLinedText tbg-purple">
                        C
                    </span>
                    <span class="header outLinedText tbg-blue">
                        L
                    </span>
                    <span class="header outLinedText tbg-green">
                        O
                    </span>
                    <span class="header outLinedText tbg-grass">
                        U
                    </span>
                    <span class="header outLinedText tbg-yellow">
                        D
                    </span>
                </div>

                <span class="cmd fa fa-sharp fa-solid fa-arrow-down-1-9" id="sortDescCmd" style="grid-column: 3;"
                    title="Date croissant" data-toggle="tooltip"></span>
                <span class="cmd fa fa-sharp fa-solid fa-arrow-up-1-9" id="sortAscCmd"
                    style="grid-column: 3; display: none;" title="Date décroissant" data-toggle="tooltip"></span>

                <span class="cmd fa fa-search-plus" id="searchCmd" style="grid-column: 4;" title="Recherche"
                    data-toggle="tooltip"></span>
                <span class="cmd fa fa-plus-square" id="newImageCmd" style="grid-column: 5;" title="Ajouter un image"
                    data-toggle="tooltip"></span>

                <span class="cmd fa fa-sign-in-alt " style="grid-column: 9; grid-row: 1;" id="loginCmd"
                    title="Connexion" data-toggle="tooltip"></span>
                <span class="cmd fa fa-right-from-bracket" style="grid-column: 9; grid-row: 1; display: none;"
                    id="logoutCmd" title="Deconnexion" data-toggle="tooltip"></span>


                <img src="" id="imgAvatar" alt=""
                    style="grid-column: 8; grid-row: 1; max-width: 60px; border-radius: 50%;" data-toggle="tooltip"
                    title="Gestion du compte">
                <span class=" cmd fa-solid fa-user-plus" id="createCmd" style="grid-column: 8;grid-row: 1;"
                    data-toggle="tooltip" title="Creation d'usager"></span>

                <div id="search_Bar_Title" style="grid-column: 2;grid-row: 2;">
                    <input type="text" id="search_input" style="grid-row: 2; grid-column: 2;" placeholder="Recherche"
                        class="form-control" required>
                </div>
                <div id="search_Bar_Account" style="grid-column: 5;grid-row: 2;">
                    <select style="grid-column: 5;grid-row: 2;" id="account_select">
                        <option value="0">Toutes</option>
                    </select>
                </div>

            </div>



        </div>

        <datalist id="searchHistory">

        </datalist>

        <div class="scrollContainer">
            <div id="imagesList">
                <!-- filled programmatically-->
            </div>
        </div>
        <div>
            <div id="imageDlg">
                <form id="imageForm">
                    <input type="hidden" id="Id_input" value="0">
                    <input type="hidden" id="date_input" value="0">
                    <input type="hidden" id="GUID_input" value="">

                    <label for="title_input">Titre</label>
                    <input type="text" id="title_input" class="form-control" required>

                    <label for="decription_input">Description</label>
                    <textarea id="description_input" class="form-control" required></textarea>

                    <label for="image">Image</label>
                    <div id='image' class='ImageUploader' defaultImage='images/No_Image.png'
                        waitingImage='images/writing.gif'>
                    </div>
                    <div class="note">Cliquez-Déposez une image</div>
                    <label for="sharedImage">Partager</label>
                    <input type="checkbox" id="shareImage"></input>
                </form>
            </div>
            <div id="confirmDeleteDlg">
                <span id="confirmationMessage"></span>
            </div>
            <div id="errorDlg">
                <span id="errorMessage"></span>
            </div>
            <div id="messageDlg">
                <span id="infoMessage"></span>
            </div>
            <div id="loginDlg">
                <form id="loginForm">
                    <input type="hidden" id="Id_input" value="0">

                    <label for="emailLogin_input">Courriel</label>
                    <input type="text" id="emailLogin_input" class="form-control" required>

                    <label for="passwordLogin_input">Mot de Passe</label>
                    <input type="password" id="passwordLogin_input" class="form-control" required></input>

                    <input type="checkbox" id="saveLoginChk">
                    <label for="saveLoginChk">Se souvenir de moi</label>
            </div>
            </form>
        </div>
        <div id="userFormDlg">
            <form id="UserForm">
                <input type="hidden" id="Id_input" value="0">

                <label for="username_input">Nom d'usager</label>
                <input type="text" id="username_input" class="form-control" required>

                <label for="email_input">Courriel</label>
                <input type="text" id="email_input" class="form-control" required>

                <label for="password_input">Mot de Passe</label>
                <input type="password" id="password_input" class="form-control" required></input>

                <label for="confirmation_input">Confirmation mot de passe</label>
                <input type="password" id="confirmation_input" class="form-control" required></input>

                <label for="imageAccount">Image</label>
                <div id='imageAccount' class='ImageUploader' defaultImage='images/No_Image.png'
                    waitingImage='images/writing.gif'>
                </div>
                <div class="note">Cliquez-Déposez une image</div>

        </div>
        </form>
        <div id="verifyAccountDlg">
            <span id="verifyMessage">Consulter votre boite de courriel pour connaitre votre code et inscriver-le
                ci-dessous</span>
            <label for="code_input">Code de vérification</label>
            <input type="text" id="code_input" class="form-control" required>
        </div>
        <div id="infoImageDlg">
            <input type="hidden" id="Id_input" value="0">
            <input type="hidden" id="date_input" value="0">
            <input type="hidden" id="GUID_input" value="">

            <br>
            <b type="text" id="title_text"></b>
            <br>
            <br>
            <a id="linkImage" target="_blank">
                <div id="imageDisplay" class='image' style="max-height: 600px;height: 350px;"> </div>
            </a>
            <p class="imageDate" id="imageInfoDate"></p>
            <br>
            <p id="description_text"></p>


        </div>
    </div>
    </div>
    </div>



    <script src="https://code.jquery.com/jquery-3.6.1.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.maskedinput/1.4.1/jquery.maskedinput.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.12.1/jquery-ui.min.js"></script>
    <script src="js/customValidation.js"></script>
    <script src="js/imageUploader.js"></script>
    <script src="js/api.js"></script>
    <script src="js/date.js"></script>
    <script src="js/accounts.js"></script>
    <script defer>
        const periodicRefreshPeriod = 15;
        let holdCheckETag = false;
        let currentETag = "";
        let createMode = true;
        let searchCategory = "";
        let searchTitle = "";
        let hideSearchBar = true;
        let imageIdToDelete = 0; // used by confirmDeleteDlg
        let selectedCategory = "";
        let selectedAccount = "";
        let createdAccountId = 0;
        let imagesCount = 50;
        let appendCount = 3;
        let previousScrollPosition = 0;
        let appendMode = false;
        let searchBarOn = false;
        let ascSort = false;
        let listAccounts = [];


        init_UI();
        HEAD(checkETag, error);
        setInterval(() => { HEAD(checkETag, error) }, periodicRefreshPeriod * 1000);

        function checkETag(ETag) {
            if (!holdCheckETag && ETag != currentETag) {
                currentETag = ETag;
                getImagesList();
            }
        }
        function searchImages() {
            searchTitle = $("#search_input").val();
            getImagesList();
        }
        function searchAccount() {
            selectedAccount = $("#account_select").val() == 0 ? "" : $("#account_select").val();
            getImagesList();
        }
        function changeSortOrder() {
            ascSort = !ascSort;
            if (ascSort) {
                $("#sortAscCmd").show();
                $("#sortDescCmd").hide();
                getImagesList();
            }
            else {
                $("#sortAscCmd").hide();
                $("#sortDescCmd").show();
                getImagesList();
            }

        }
        function openSearchBar() {
            if (searchBarOn) {
                $("#search_Bar_Title").show();
                $("#search_Bar_Account").show();
                $("#searchCmd").toggleClass("fa-search-plus", false)
                $("#searchCmd").toggleClass("fa-search-minus", true)
            }
            else {
                $("#search_Bar_Title").hide();
                $("#search_Bar_Account").hide();
                $("#searchCmd").toggleClass("fa-search-plus", true)
                $("#searchCmd").toggleClass("fa-search-minus", false)
            }
            searchBarOn = !searchBarOn;
        }

        function resetLoginForm() {
            $("#emailLogin_input").val(localStorage.getItem("SavedEmail"))
            $("#passwordLogin_input").val("")
        }
        function getImagesList(refresh = true) {
            appendMode = !refresh;
            function prepareQueryString() {
                let queryString = "?";
                let sortOrder = ascSort ? "sort=date,asc" : "sort=date,desc";
                queryString += `${sortOrder}`
                if (appendMode) {
                    queryString += `&offset=${Math.trunc(imagesCount / appendCount)}&limit=${appendCount}`;
                    imagesCount += appendCount;
                } else {
                    queryString += `&offset=${0}&limit=${imagesCount}`;
                }
                if (selectedAccount != "")
                    queryString += "&UserId=" + selectedAccount;
                if (searchTitle != "")
                    queryString += "&Title=*" + searchTitle + "*";

                return queryString;
            }
            GET_ALL(refreshimagesList, error, prepareQueryString());
        }
        function refreshimagesList(images, ETag) {
            let listAccounts;
            if (JSON.parse(localStorage.getItem("token")) != null) {
                getAllAccounts((data) => { localStorage.setItem("listAccounts", JSON.stringify(data)); })
                listAccounts = JSON.parse(localStorage.getItem("listAccounts"));
            }
            function insertIntoImageList(image) {
                if (image.Shared || JSON.parse(localStorage.getItem("token")) != null && image.UserId == JSON.parse(localStorage.getItem("token")).UserId) {
                    
                    $("#imagesList").append(
                        $(` 
                                <div class='imageLayout'>
                                
                                    <div class='imageHeader' id='imageHeader${image.Id}'>
                                        <div class="imageTitle">${image.Title}</div>
                                        
                                        </div>
                                        <div class='image${image.Id}'>
                                            <div id='imageDisplay${image.Id}' class='image' 
                                                style="background-image:url('${image.ThumbnailURL}')">
                                            </div>
                                    <div class="imageDate">${convertToFrenchDate(parseInt(image.Date))}</div>
                                        </div>
                                </div>
                        `)
                    );
                    $(`.image${image.Id}`).on("click", () => openInfoImageDlg(image));

                    if (localStorage.getItem("token") != null && JSON.parse(localStorage.getItem("token")).UserId == image.UserId) {
                        $(`#imageHeader${image.Id}`).append(`
                                        <div    class="cmd editCmd  fa fa-pencil-square" 
                                                imageid="${image.Id}" 
                                                title="Editer ${image.Title}" 
                                                data-toggle="tooltip">
                                        </div>
                                        <div    class="cmd deleteCmd fa fa-window-close" 
                                                imageid="${image.Id}" 
                                                title="Effacer ${image.Title}" 
                                                data-toggle="tooltip">
                                        </div>`);
                    }
                }
                if(JSON.parse(localStorage.getItem("token")) != null){
                   let user = listAccounts.find((user)=>user.Id == image.UserId);
                   $(`#imageDisplay${image.Id}`).append($(`<img src="${user.AvatarURL}" id="imgAvatar" alt="" style="grid-column: 8; grid-row: 1; max-width: 60px; border-radius: 50%;" data-toggle="tooltip" title="${user.Name}">`));
                }
            }
            currentETag = ETag;
            previousScrollPosition = $(".scrollContainer").scrollTop();
            if (!appendMode) $("#imagesList").empty();

            if (appendMode && images.length == 0)
                imagesCount -= appendCount;

            for (let image of images) {
                insertIntoImageList(image);
            }

            $(".scrollContainer").scrollTop(previousScrollPosition);
            $(".editCmd").off();
            $(".deleteCmd").off();
            $(".showMore").off();
            $(".editCmd").click(e => { editimage(e) });
            $(".deleteCmd").click(e => { deleteimage(e) });

            $('[data-toggle="tooltip"]').tooltip();
        }


        function error(status) {
            let errorMessage = "";
            switch (status) {
                case 0:
                    errorMessage = "Le service ne répond pas";
                    break;
                case 401:
                    errorMessage = "Requête non autorisée";
                    break;
                case 400:
                case 422:
                    errorMessage = "Requête invalide";
                    break;
                case 404:
                    errorMessage = "Service ou données introuvables";
                    break;
                case 409:
                    errorMessage = "Conflits de données: Hyperlien existe déjà";
                    break;
                case 500:
                    errorMessage = "Erreur interne du service";
                    break;
                default:
                    errorMessage = "Une erreur est survenue";
                    break;
            }
            $("#errorMessage").text(errorMessage);
            $("#errorDlg").dialog('open');
        }

        function newImage() {
            holdCheckETag = true;
            createMode = true;
            resetimageForm();
            ImageUploader.imageRequired('image', true);
            $("#imageDlg").dialog('option', 'title', "Ajout d'image");
            $("#imageDlgOkBtn").text("Ajouter");
            $("#imageDlg").dialog('open');
        }
        function editimage(e) {
            holdCheckETag = true;
            createMode = false;
            GET_ID(e.target.getAttribute("imageid"), imageToForm, error);
            holdCheckETag = true;
            ImageUploader.imageRequired('image', false);
            $("#imageDlg").dialog('option', 'title', "Modification d'image");
            $("#imageDlgOkBtn").text("Modifier");
            $("#imageDlg").dialog('open');
        }
        function deleteimage(e) {
            holdCheckETag = true;
            imageIdToDelete = e.target.getAttribute("imageid")
            GET_ID(
                imageIdToDelete,
                image => {
                    $("#confirmationMessage").html("Voulez-vous vraiment effacer l'image <br><b>" + image.Title + "</b>?")
                },
                error
            );
            holdCheckETag = true;
            $("#confirmDlg").dialog('option', 'title', "Retrait d'image'...");
            $("#confirmDeleteDlgOkBtn").text("Effacer");
            $("#confirmDeleteDlg").dialog('open');
        }
        function resetimageForm() {
            $("#Id_input").val("0");
            $("#GUID_input").val("");
            $("#date_input").val(Date.now());
            $("#title_input").val("");
            $("#description_input").val("");
            ImageUploader.resetImage('image');
        }
        function imageFromForm() {
            if ($("#imageForm")[0].checkValidity()) {
                let image = {
                    Id: parseInt($("#Id_input").val()),
                    GUID: $("#GUID_input").val(),
                    Title: $("#title_input").val(),
                    Description: $("#description_input").val(),
                    ImageData: ImageUploader.getImageData('image'),
                    Date: parseInt($("#date_input").val()),
                    UserId: JSON.parse(localStorage.getItem("token")).UserId,
                    Shared: $("#shareImage").is(":checked")
                };
                return image;
            } else {
                $("#imageForm")[0].reportValidity()
            }
            return false;
        }
        function imageToForm(image) {
            $("#Id_input").val(image.Id);
            $("#GUID_input").val(image.GUID);
            $("#date_input").val(image.Date);
            //$("#date_input").val(Date.now());
            $("#title_input").val(image.Title);
            $("#description_input").val(image.Description);
            ImageUploader.setImage('image', image.OriginalURL);
            $("#shareImage").prop("checked", image.Shared);
        }


        function init_UI() {
            $("#newImageCmd").click(newImage)
            $("#loginCmd").click(loginDlg)
            $("#search_input").on("input", searchImages)
            $("#searchCmd").click(openSearchBar)
            $("#logoutCmd").click(accountLogout)
            $("#account_select").change(searchAccount)
            $("#createCmd").click(createAccountDlg)
            $("#account_select").hide()
            $("#userFormDlg").hide()
            $("#UserInfoDlg").hide()
            $("#newImageCmd").hide()
            $("#sortAscCmd").hide()
            $("#sortAscCmd").click(changeSortOrder)
            $("#sortDescCmd").click(changeSortOrder)
            $("#imgAvatar").click(updateAccountDlg)
            openSearchBar();

            $("#imageDlg").dialog({
                title: "...",
                autoOpen: false,
                modal: true,
                show: { effect: 'fade', speed: 400 },
                hide: { effect: 'fade', speed: 400 },
                width: 640,
                minWidth: 640,
                maxWidth: 640,
                height: 780,
                minHeight: 780,
                maxHeight: 780,
                position: { my: "top", at: "top", of: window },
                buttons: [{
                    id: "imageDlgOkBtn",
                    text: "Title will be changed dynamically",
                    click: function () {
                        let image = imageFromForm();
                        if (image) {
                            if (createMode) {
                                POST(image, getImagesList, error);
                                $(".scrollContainer").scrollTop(0);
                            }
                            else
                                PUT(image, getImagesList, error);
                            resetimageForm();
                            holdCheckETag = false;
                            $(this).dialog("close");
                        }
                    }
                },
                {
                    text: "Annuler",
                    click: function () {
                        holdCheckETag = false;
                        $(this).dialog("close");
                    }
                }]
            });
            $("#infoImageDlg").dialog({
                title: "...",
                autoOpen: false,
                modal: true,
                show: { effect: 'fade', speed: 400 },
                hide: { effect: 'fade', speed: 400 },
                width: 640,
                minWidth: 640,
                maxWidth: 640,
                height: 600,
                minHeight: 500,
                maxHeight: 780,
                position: { my: "top", at: "top", of: window },
                buttons: []
            });

            $("#confirmDeleteDlg").dialog({
                title: "Attention!",
                autoOpen: false,
                modal: true,
                show: { effect: 'fade', speed: 400 },
                hide: { effect: 'fade', speed: 400 },
                width: 500, minWidth: 500, maxWidth: 500,
                height: 230, minHeight: 230, maxHeight: 230,
                position: { my: "top", at: "top", of: window },
                buttons: [{
                    id: "confirmDeleteDlgOkBtn",
                    text: "Oui",
                    click: function () {
                        holdCheckETag = false;
                        if (imageIdToDelete)
                            DELETE(imageIdToDelete, getImagesList, error);
                        imageIdToDelete = 0;
                        $(this).dialog("close");
                    }
                },
                {
                    text: "Annuler",
                    click: function () {
                        holdCheckETag = false;
                        imageIdToDelete = 0;
                        $(this).dialog("close");
                    }
                }]
            });

            $("#errorDlg").dialog({
                title: "Erreur...",
                autoOpen: false,
                modal: true,
                show: { effect: 'fade', speed: 400 },
                hide: { effect: 'fade', speed: 400 },
                width: 500, minWidth: 500, maxWidth: 500,
                height: 230, minHeight: 230, maxHeight: 230,
                position: { my: "top", at: "top", of: window },
                buttons: [{
                    text: "Fermer",
                    click: function () {
                        holdCheckETag = false;
                        imageIdToDelete = 0;
                        $(this).dialog("close");
                    }
                }]
            });
            $("#loginDlg").dialog({
                title: "Connexion",
                autoOpen: false,
                modal: true,
                show: { effect: 'fade', speed: 400 },
                hide: { effect: 'fade', speed: 400 },
                width: 350, minWidth: 300, maxWidth: 350,
                height: 400, minHeight: 230, maxHeight: 400,
                position: { my: "top", at: "top", of: window },
                buttons: [{
                    id: "loginConfirmDlgOkBtn",
                    text: "Connexion",
                    click: function () {
                        holdCheckETag = false;
                        let loginInfo = {
                            Email: $("#emailLogin_input").val(),
                            Password: $("#passwordLogin_input").val()
                        }
                        if ($("#saveLoginChk").is(":checked")) {
                            localStorage.setItem("SavedEmail", $("#emailLogin_input").val());
                        }
                        else if (localStorage.getItem("SavedEmail") != null) {
                            localStorage.removeItem("SavedEmail");
                        }
                        login(loginInfo, accountLogin, () => openMessageDlg("Erreur connexion", "Le nom d'utilisateur ou le mot de passe est invalide"));

                    }
                },
                {
                    id: "loginCancelDlgOkBtn",
                    text: "Annuler",
                    click: function () {
                        holdCheckETag = false;
                        resetLoginForm();
                        $(this).dialog("close");
                    }
                }
                ]

            });
            $("#userFormDlg").dialog({
                title: "...",
                autoOpen: false,
                modal: true,
                show: { effect: 'fade', speed: 400 },
                hide: { effect: 'fade', speed: 400 },
                width: 640,
                minWidth: 660,
                maxWidth: 660,
                height: 750,
                minHeight: 750,
                maxHeight: 750,
                position: { my: "top", at: "top", of: window },
                buttons: [
                    {
                        id: "userInfoRemoveDlgOkBtn",
                        text: "Fermer compte",
                        click: function () {
                            let userId = JSON.parse(localStorage.getItem("token")).UserId;
                            holdCheckETag = false;
                            removeImagesUser(userId,(data)=>{
                                data.forEach(element => {
                                    DELETE(element.Id,getImagesList,error);
                                    deleteUser(userId);
                                    accountLogout();
                                });
                                
                            },(error)=>console.log(error));
                            
                            $(this).dialog("close");
                        }
                    },
                    {
                        id: "userInfoCancelDlgOkBtn",
                        text: "Annuler",
                        click: function () {
                            holdCheckETag = false;
                            $("#username_input").val("");
                            $("#email_input").val("");
                            $("#password_input").val("");
                            $("#confirmation_input").val("");
                            $(this).dialog("close");
                        }
                    },
                    {
                        id: "userInfoConfirmDlgOkBtn",
                        text: "...",
                        click: function () {
                            holdCheckETag = false;
                            if ($("#UserForm")[0].checkValidity()) {
                                if ($("#password_input").val() == $("#confirmation_input").val()) {
                                    let user = userInfoFromForm();

                                    if (user.Id == 0) {
                                        userCreation(user, getUserIdFromCreatedAccount, error);
                                        $("#verifyAccountDlg").dialog("open");
                                    }
                                    else {
                                        updateUser(user, openMessageDlg);
                                        $(this).dialog("close");
                                    }
                                    fillAccountInfo(user);
                                    $(this).dialog("close");
                                }
                                else {
                                    openMessageDlg("Erreur création", "Le mot de passe doit être identique");
                                }
                            }
                            else {
                                $("#UserForm")[0].reportValidity();
                            }
                        }
                    }
                ]

            });
            $("#verifyAccountDlg").dialog({
                title: "Verification",
                autoOpen: false,
                modal: true,
                show: { effect: 'fade', speed: 400 },
                hide: { effect: 'fade', speed: 400 },
                width: 350, minWidth: 350, maxWidth: 350,
                height: 350, minHeight: 350, maxHeight: 350,
                position: { my: "top", at: "top", of: window },
                buttons: [{
                    id: "confirmVerifDlgOkBtn",
                    text: "Envoyer",
                    click: function () {
                        holdCheckETag = false;
                        let code = $("#code_input").val();
                        if (code) {
                            verifyUser(createdAccountId, code, () => {
                                openMessageDlg("Compte validé",
                                    "Votre compte a bien été valide vous pouvez maintenant vous connecter");
                                $("#loginDlg").dialog("close");
                            }
                                , error);
                            
                            $(this).dialog("close");
                        }

                    }
                },
                {
                    text: "Annuler",
                    click: function () {
                        holdCheckETag = false;

                        $(this).dialog("close");
                    }
                }]
            });
            $("#messageDlg").dialog({
                title: "Message",
                autoOpen: false,
                modal: true,
                show: { effect: 'fade', speed: 400 },
                hide: { effect: 'fade', speed: 400 },
                width: 500, minWidth: 500, maxWidth: 500,
                height: 230, minHeight: 230, maxHeight: 230,
                position: { my: "top", at: "top", of: window },
                buttons: [{
                    text: "Fermer",
                    click: function () {
                        holdCheckETag = false;
                        imageIdToDelete = 0;
                        $(this).dialog("close");
                    }
                }]
            });

            $(".scrollContainer").scroll(function () {
                if ($(".scrollContainer").scrollTop() + $(".scrollContainer").innerHeight() >= $("#imagesList").height()) {
                    getImagesList(false);
                }
            });
            if (localStorage.getItem("token") != null) {
                getAllAccounts(fillSelectAccounts, error);
                getAccountInfo(JSON.parse(localStorage.getItem("token")).UserId, fillAccountInfo, error)
                getImagesList();
                loggedAccountStatus();
            }

        }
        function loginDlg() {
            holdCheckETag = true;
            $("#loginDlg").dialog("open");
        }
        function accountLogin(data) {
            
                localStorage.setItem("token", JSON.stringify(data));
                loggedAccountStatus();
                getAllAccounts(fillSelectAccounts, error);
                getAccountInfo(JSON.parse(localStorage.getItem("token")).UserId, fillAccountInfo, error)
                getImagesList();
                resetLoginForm();
                $("#loginDlg").dialog("close");
            
        }
        function loggedAccountStatus() {
            if (localStorage.getItem("token") != null) { // CHECK IF ACCOUNT IS LOG
                $("#loginCmd").hide();
                $("#createCmd").hide();
                $("#account_select").show();
                $("#logoutCmd").show();
                $("#newImageCmd").show();

            }
            else {
                $("#loginCmd").show();
                $("#createCmd").show();
                $("#newImageCmd").hide();
                $("#account_select").hide();
                $("#logoutCmd").hide();
                $("#imgAvatar").attr("src", "");
            }
        }
        function accountLogout() {
            logout(JSON.parse(localStorage.getItem("token")).UserId, error);
            localStorage.removeItem("token");
            loggedAccountStatus();
            getImagesList();
        }
        function fillSelectAccounts(data) {
            $("#account_select").empty();

            for (let i = 0; i < data.length; i++) {
                $("#account_select").append(`<option value="${data[i].Id}">${data[i].Name}</option>`);
            }
            $("#account_select").append(`<option selected value="0">Toutes</option>`);
        }
        function fillAccountInfo(data) {
            $("#imgAvatar").attr("src", data.AvatarURL != "" ? data.AvatarURL : "images/No_Image.png");
            $("#username_input").val(data.Name)
            $("#email_input").val(data.Email)
            ImageUploader.setImage("imageAccount", data.AvatarURL);
            ImageUploader.imageRequired('image', false);
        }
        function clearAccountInfo(data) {
            $("#username_input").val("")
            $("#email_input").val("")
            ImageUploader.resetImage("imageAccount")
        }
        function createAccountDlg() {
            holdCheckETag = true;
            clearAccountInfo();
            $("#userFormDlg").dialog("open");
            $("#userFormDlg").dialog('option', 'title', "Création du compte");
            $("#userInfoConfirmDlgOkBtn").text("Créer");
            $("#userInfoRemoveDlgOkBtn").hide();
        }
        function updateAccountDlg() {
            let userId = JSON.parse(localStorage.getItem("token")).UserId;
            getAccountInfo(userId, fillAccountInfo, error);
            $("#userFormDlg").dialog('option', 'title', "Modification du compte");
            $("#userFormDlg").dialog("open");
            $("#userInfoConfirmDlgOkBtn").text("Mettre a jour");
            $("#userInfoRemoveDlgOkBtn").show();
        }
        function userInfoFromForm() {
            let user = {
                Id: JSON.parse(localStorage.getItem("token")) != null ? JSON.parse(localStorage.getItem("token")).UserId : parseInt(0),
                Name: $("#username_input").val(),
                Email: $("#email_input").val(),
                Password: $("#password_input").val(),
                ImageData: ImageUploader.getImageData("imageAccount")
            }
            return user;
        }
        function getUserIdFromCreatedAccount(data) {
            createdAccountId = data.Id;
        }
        function openMessageDlg(title, message) {
            $("#messageDlg").dialog("option", "title", title);
            $("#infoMessage").text(message);
            $("#messageDlg").dialog("open");
        }
        function openInfoImageDlg(image) {
            $("#infoImageDlg").dialog("option", "title", ``); // Changer le titre pour qql chose de mieux
            $("#title_text").text(image.Title);
            $("#imageInfoDate").text(`${convertToFrenchDate(parseInt(image.Date))}`);
            $("#imageDisplay").css("background-image", `url("${image.ThumbnailURL}")`);
            $("#description_text").text(image.Description);
            $("#linkImage").attr("href", `${image.OriginalURL}`);
            $("#infoImageDlg").dialog("open");
        }

    </script>

</body>

</html>